<?php

namespace App\Jobs;

use App\Events\NewSentimentEvent;
use App\Http\Controllers\SentimentAssets\SentimentAssetsController;
use App\Models\GenericAttribute;
use App\Models\GoogleApp;
use App\Models\GoogleReview;
use App\Models\GoogleReviewSentiment;
use App\Models\User;
use App\Models\UserJob;
use App\Notifications\GoogleSentiment;
use App\Notifications\InsufficientTokensNotification;
use App\Services\OpenAIConfig;
use App\Services\OpenAIPrompt;
use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldBeUnique;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Queue\SerializesModels;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Log;
use Yethee\Tiktoken\EncoderProvider;

class ProcessGooglePlayAnalysis implements ShouldQueue
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;

    public $timeout = 3600; // Timeout in seconds
    protected $requestData;
    protected $userId;
    /**
     * Create a new job instance.
     */
    public function __construct($requestData, $userId)
    {
        $this->requestData = $requestData;
        $this->userId = $userId;
    }

    /**
     * Execute the job.
     */
    public function handle(): void
    {
        $validatedData = $this->requestData;
        $user = User::find($this->userId);

        try {

            // Save job details in `user_jobs`
            $job = new UserJob([
                'job_id'        => $this->job->getJobId(),
                'status'        => 'processing', // or any initial status
                'request_type'  => 'sentiment',
                'request_count' => $validatedData['number_of_reviews'],
                'completed_count' => 0, // set to 0 at the start
                'user_id' => $user->id
            ]);

            // Assuming this is associated with a GoogleApp
            $googleApp = GoogleApp::find($validatedData['appId']);
            $googleApp->jobs()->save($job); // Saving polymorphic relation
            $jobId = $job->id;

            if (!$user) {
                Log::error('User not found', ['userId' => $this->userId]);
                return;
            }
            $assets = new SentimentAssetsController();

            $reviews = $assets->fetchReviews($validatedData['appId'], $validatedData['number_of_reviews'], "google");
            
            $brandDetails = $assets->getBrandDetails($validatedData['appId'], "google");

            if (empty($brandDetails)) {
                Log::error('App details not found', ['appId' => $validatedData['appId']]);
                return;
            }

            $openAIPrompt = new OpenAIPrompt();
            $prompt = $openAIPrompt->sentimentAnalysisPrompt($brandDetails);

            $encoder = (new EncoderProvider())->getForModel('gpt-4o');

            $assets->processMultipleReviews($encoder, $user, $reviews, $prompt, $brandDetails['brandId'], "google", $jobId);

            // Update job details after processing
            $job->update([
                'status' => 'completed',  // Update the status to completed
            ]);
            

            if ($user->user_token > 0) {
                $user->notify(new GoogleSentiment ($brandDetails['brandName'], $brandDetails['brandId']));
            }

            broadcast(new NewSentimentEvent());

        } catch (\Exception $e) {
            Log::error("Job failed: {$e->getMessage()}", [
                'userId' => $this->userId,
                'appId' => $validatedData['appId'] ?? null,
                'exception' => $e,
            ]);
    
            $job = UserJob::where('job_id', $this->job->getJobId())->first();
            if ($job) {
                $job->update([
                    'status' => 'failed',
                ]);
            }

            throw $e;
        }

    }





}



[2025-06-22 13:10:53] local.WARNING: OpenAI returned no content for review {"reviewId":5147} 
[2025-06-22 13:10:53] local.ERROR: SQLSTATE[08S02]: [Microsoft][ODBC Driver 17 for SQL Server]SMux Provider: Physical connection is not usable [xFFFFFFFF].  {"exception":"[object] (PDOException(code: 08S02): SQLSTATE[08S02]: [Microsoft][ODBC Driver 17 for SQL Server]SMux Provider: Physical connection is not usable [xFFFFFFFF].  at /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Database/Concerns/ManagesTransactions.php:297)
[stacktrace]
#0 /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Database/Concerns/ManagesTransactions.php(297): PDO->rollBack()
#1 /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Database/Concerns/ManagesTransactions.php(269): Illuminate\\Database\\Connection->performRollBack()
#2 /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Database/Concerns/ManagesTransactions.php(104): Illuminate\\Database\\Connection->rollBack()
#3 /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Database/Concerns/ManagesTransactions.php(39): Illuminate\\Database\\Connection->handleTransactionException()
#4 /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Database/SqlServerConnection.php(38): Illuminate\\Database\\Connection->transaction()
#5 /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Queue/DatabaseQueue.php(226): Illuminate\\Database\\SqlServerConnection->transaction()
#6 /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Queue/Worker.php(351): Illuminate\\Queue\\DatabaseQueue->pop()
#7 /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Queue/Worker.php(366): Illuminate\\Queue\\Worker->Illuminate\\Queue\\{closure}()
#8 /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Queue/Worker.php(164): Illuminate\\Queue\\Worker->getNextJob()
#9 /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Queue/Console/WorkCommand.php(149): Illuminate\\Queue\\Worker->daemon()
#10 /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Queue/Console/WorkCommand.php(132): Illuminate\\Queue\\Console\\WorkCommand->runWorker()
#11 /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Container/BoundMethod.php(36): Illuminate\\Queue\\Console\\WorkCommand->handle()
#12 /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Container/Util.php(43): Illuminate\\Container\\BoundMethod::Illuminate\\Container\\{closure}()
#13 /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Container/BoundMethod.php(95): Illuminate\\Container\\Util::unwrapIfClosure()
#14 /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Container/BoundMethod.php(35): Illuminate\\Container\\BoundMethod::callBoundMethod()
#15 /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Container/Container.php(694): Illuminate\\Container\\BoundMethod::call()
#16 /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Console/Command.php(213): Illuminate\\Container\\Container->call()
#17 /var/www/html/Web-Scrapping-Backend/vendor/symfony/console/Command/Command.php(279): Illuminate\\Console\\Command->execute()
#18 /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Console/Command.php(182): Symfony\\Component\\Console\\Command\\Command->run()
#19 /var/www/html/Web-Scrapping-Backend/vendor/symfony/console/Application.php(1094): Illuminate\\Console\\Command->run()
#20 /var/www/html/Web-Scrapping-Backend/vendor/symfony/console/Application.php(342): Symfony\\Component\\Console\\Application->doRunCommand()
#21 /var/www/html/Web-Scrapping-Backend/vendor/symfony/console/Application.php(193): Symfony\\Component\\Console\\Application->doRun()
#22 /var/www/html/Web-Scrapping-Backend/vendor/laravel/framework/src/Illuminate/Foundation/Console/Kernel.php(198): Symfony\\Component\\Console\\Application->run()
#23 /var/www/html/Web-Scrapping-Backend/artisan(35): Illuminate\\Foundation\\Console\\Kernel->handle()
#24 {main}
"} 

